{% assign projects = include.source %}
{% assign featured_count = include.featured | default: 3 %}
{% assign pinned_projects = projects | where: 'pinned', true %}
{% assign other_projects = projects | where_exp: 'item', 'item.pinned != true' %}
{% assign projects = pinned_projects | concat: other_projects %}
{% assign total_projects = projects | size %}
{% assign show_toggle = total_projects > featured_count %}

<div class="project-gallery">
  {% for project in projects limit:featured_count %}
    {% assign primary_link = project.article_link | default: project.github | default: project.pdf %}
    {% assign card_group = 'project-' | append: forloop.index0 %}

    {% assign title_ko = project.title.ko | default: project.title %}
    {% assign title_en = project.title.en | default: title_ko %}
    {% assign abstract_ko = project.abstract.ko | default: project.abstract %}
    {% assign abstract_en = project.abstract.en | default: abstract_ko %}

    <article class="project-card{% if primary_link %} project-card--linked{% endif %}">
      {% if primary_link %}
        <a class="project-card__overlay" href="{{ primary_link }}" target="_blank" rel="noopener" aria-label="{{ title_en }}"></a>
      {% endif %}

      <div class="project-card__thumb">
        {% if project.image %}
          <img src="{{ project.image | strip }}" alt="{{ title_en }} thumbnail" loading="lazy" class="project-card__image">
        {% else %}
          <span class="project-card__thumb-placeholder">{{ title_en | slice: 0, 1 }}</span>
        {% endif %}
      </div>

      <div class="project-card__content">
        <header class="project-card__header">
          {% if project.year or project.pinned %}
            <div class="project-card__meta">
              {% if project.year %}
                <span class="project-card__year">
                  <span class="lang-content" data-lang="ko" data-lang-group="{{ card_group }}-year">{{ project.year.ko | default: project.year }}</span>
                  <span class="lang-content" data-lang="en" data-lang-group="{{ card_group }}-year">{{ project.year.en | default: project.year }}</span>
                </span>
              {% endif %}
              {% if project.pinned %}
                <span class="project-card__pin-icon" title="Pinned" aria-hidden="true">üìå</span>
              {% endif %}
            </div>
          {% endif %}
          <h4 class="project-card__title">
            <span class="lang-content" data-lang="ko" data-lang-group="{{ card_group }}-title">{{ title_ko }}</span>
            <span class="lang-content" data-lang="en" data-lang-group="{{ card_group }}-title">{{ title_en }}</span>
          </h4>
        </header>

        {% if project.dev_tool %}
          <ul class="project-card__tags">
            {% for dev_tool in project.dev_tool %}
              <li class="project-card__tag">{{ dev_tool }}</li>
            {% endfor %}
          </ul>
        {% endif %}

        {% if abstract_ko or abstract_en %}
          <div class="project-card__abstract">
            <p class="lang-content" data-lang="ko" data-lang-group="{{ card_group }}-abstract">{{ abstract_ko }}</p>
            <p class="lang-content" data-lang="en" data-lang-group="{{ card_group }}-abstract">{{ abstract_en }}</p>
          </div>
        {% endif %}

        <div class="project-card__actions">
          {% if project.github %}
            <a href="{{ project.github }}" target="_blank" rel="noopener" class="project-card__action project-card__action--github">GitHub</a>
          {% endif %}
          {% if project.pdf %}
            <a href="{{ project.pdf }}" target="_blank" rel="noopener" class="project-card__action project-card__action--pdf">Report</a>
          {% endif %}
        </div>
      </div>
    </article>
  {% endfor %}
</div>

{% if show_toggle %}
  <details class="project-collapsed" data-projects-toggle>
    <summary>
      <span class="lang-content" data-lang="ko" data-lang-group="project-toggle">Îçî ÎßéÏùÄ ÌîÑÎ°úÏ†ùÌä∏ Î≥¥Í∏∞</span>
      <span class="lang-content" data-lang="en" data-lang-group="project-toggle">Show more projects</span>
    </summary>

    <div class="project-compact-list">
      {% for project in projects offset:featured_count %}
        {% assign title_ko = project.title.ko | default: project.title %}
        {% assign title_en = project.title.en | default: title_ko %}
        {% assign compact_group = 'project-compact-' | append: forloop.index0 %}
        <div class="project-compact-item">
          <span class="project-compact-item__year">
            <span class="lang-content" data-lang="ko" data-lang-group="{{ compact_group }}-year">{{ project.year.ko | default: project.year }}</span>
            <span class="lang-content" data-lang="en" data-lang-group="{{ compact_group }}-year">{{ project.year.en | default: project.year }}</span>
          </span>
          <a href="{{ project.article_link | default: project.github | default: project.pdf | default: '#' }}" class="project-compact-item__title">
            {% if project.pinned %}<span class="project-compact-item__pin" aria-hidden="true">üìå</span>{% endif %}
            <span class="lang-content" data-lang="ko" data-lang-group="{{ compact_group }}-title">{{ title_ko }}</span>
            <span class="lang-content" data-lang="en" data-lang-group="{{ compact_group }}-title">{{ title_en }}</span>
          </a>
          {% if project.dev_tool %}
            <span class="project-compact-item__tags">{{ project.dev_tool | join: ' ¬∑ ' }}</span>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </details>
{% endif %}
